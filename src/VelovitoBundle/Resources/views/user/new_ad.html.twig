{% extends 'VelovitoBundle::base.html.twig' %}
{% import '@Velovito/templates/macroses.html.twig' as macro %}
{% block body %}
    {{ form_start(form) }}
    {{ macro.bootstrapFormInput(form.title) }}
    {{ macro.bootstrapFormInput(form.price) }}
    {{ macro.bootstrapFormInput(form.category) }}
    {{ macro.bootstrapFormInput(form.status) }}
    {{ macro.bootstrapFormInput(form.description) }}

    <div id="images_pool">
        <div class="uploading_image">
            <img src="http://velo.local/img/temporary_thumbs/4c5e18e08e220169403f707b72ed6952.png" alt="">
            <div class="remove_image"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></div>
        </div>
    </div>

    {{ form_widget(form.save) }}
    {{ form_widget(form.publish) }}
    {{ form_rest(form) }}
    {{ form_end(form) }}

    <br/>

    {{ form_start(uploadForm, {'attr':{ 'id': 'photo' }}) }}
    {{ form_widget(uploadForm.photo) }}
    {{ form_widget(uploadForm.submit) }}
    {{ form_end(uploadForm) }}

    <br/>

    <script src="{{ asset('js/jquery.form.min.js') }}"></script>

    <script>
        var tmpImagePath = '{{ app.request.getSchemeAndHttpHost() }}/img/temporary_thumbs/';
        $("#photo").ajaxForm({
            url: '{{ url('ajax_upload_photo') }}',
            type: 'post',
            beforeSubmit: onBeforeSubmit,
            success: onSuccess
        });

        function onBeforeSubmit(formData, jqForm, options) {
            var queryString = $.param(formData);
            console.log('About to submit: \n\n' + queryString);

            return true;
        }

        function createUploadingImageBlock() {

        }

        function onSuccess(responseText, statusText, xhr, $form) {
            switch(xhr.status){
                case 200:
                    var img = $('<img>');
                    img.attr('src', tmpImagePath + responseText);
                    $("#images_pool").append(img);
                default :
                    console.log(xhr);
            }
        }

        var client = new XMLHttpRequest();

        function upload() {
            var file = document.getElementById("uploadfile");

            var formData = new FormData();
            formData.append("upload", file.files[0]);

            client.open("post", "{{ url('ajax_upload_photo') }}", true);
            client.setRequestHeader("Content-Type", "multipart/form-data");
            client.send(formData);
        }

        client.onreadystatechange = function () {
            if (client.readyState == 4 && client.status == 200) {
                alert(client.statusText);
            }
        }
    </script>
{% endblock %}